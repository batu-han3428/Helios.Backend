trigger:
  branches:
    include:
      - main

pool:
  name: 'vmssagents-pool'



variables:
 
  # Azure Container Registry details
  acrName: 'medcase'
  registry: 'medcase.azurecr.io'
  tag: '$(Build.BuildId)'

  # Kubernetes details
  aksClusterName: 'medcase-cluster-dev'
  kubernetesNamespace: 'helios-testing'  # e.g., production
  azureServiceConnection: 'Medcase-Azure-Cli' 
  dockerRegistryServiceConnection: 'medcase'
steps:
- checkout: self  # This is the correct way to reference the checkout step

- script: |
    whoami
    az --version
    sudo az --version
    echo "Listing Docker images..."
    docker ps
    echo "Listing files..."
    ls -R .
    if [ ! -f "./Helios.sln" ]; then
      echo "Project file not found!"
      exit 1
    fi
     if [ ! -f "./pipeline/build-docker.sh" ]; then
      echo "build-docker.sh file not found!"
      exit 1
    fi
  displayName: 'Verify project file exists'

- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.x'
    installationPath: $(Agent.ToolsDirectory)/dotnet

- script: dotnet --version
  displayName: 'Check .NET Version'


# - script: |
#     echo "Installing Azure CLI..."
#     apt-get install -y azure-cli
#     az --version
#   displayName: 'Install Azure CLI'

- task: AzureCLI@2
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      whoami
      az acr login --name $(acrName) --expose-token
      echo "Listing images in ACR..."
      az acr repository list --name $(acrName) --output table

# - task: Docker@2
#   inputs:
#     command: login
#     containerRegistry: $(dockerRegistryServiceConnection)
#   displayName: 'Login to ACR'
- task: AzureCLI@2
  inputs:
    azureSubscription: $(azureSubscription)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "Adding user to group..."
      sudo usermod -aG $(group) AzDevOps

      echo "Running az command as the user..."
      sudo -u AzDevOps az account show
  displayName: 'Modify user and run Azure CLI command'


- script: |
    sudo -u AzDevOps az acr login --name $(acrName) --expose-token
    docker ps
    chmod +x ./pipeline/build-docker.sh  # Make the script executable
    ./pipeline/build-docker.sh $(registry)/helios 'helios-core' $(tag) './Helios.EDC/Helios.Core/Dockerfile'
  displayName: '[Core Api] Build and Push Docker Image'

- task: Kubernetes@1
  displayName: 'Deploy to AKS'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: 'Medcase-Azure-Cli'
    azureResourceGroup: 'medcase-cluster'
    kubernetesCluster: '$(aksClusterName)'
    namespace: '$(kubernetesNamespace)'
    command: 'apply'
    useConfigurationFile: false
    arguments: |
      -f deploy/deployment-core.yaml
    secretType: 'None'